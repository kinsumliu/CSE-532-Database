xquery version "3.0";
declare default element namespace "http://localhost:8080/exist/apps/tss-collection";

declare function local:contestant1PlayAllPieceContestant2Play
($contestant1 as element()* , $contestant2 as element()*)
as xs:boolean?{
    let $tss := doc("/db/apps/tss-collection/tss.xml")/TSS,
        $contestant2Pieces :=
            for $audition2 in $tss/Show/Audition
            where $audition2/Contestant = $contestant2
            return $audition2/Piece
    return
        distinct-values(
            for $audition1 in $tss/Show/Audition
            where every $piece in $contestant2Pieces satisfies $audition1/Piece = $piece
                and $audition1/Contestant = $contestant1
            return 
                fn:true()
        )
 };
 
let $tss := doc("/db/apps/tss-collection/tss.xml")/TSS
return
    <query4>
    {
        for $contestant1 in $tss/Show/Audition/Contestant,
            $contestant2 in $tss/Show/Audition/Contestant
        where local:contestant1PlayAllPieceContestant2Play($contestant1, $contestant2) and
            not(local:contestant1PlayAllPieceContestant2Play($contestant2, $contestant1))
        return <result>{concat($contestant1, ' dominates ', $contestant2)}</result>
    }</query4>